{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/dev-enterprises/middleware.ts"],"sourcesContent":["/**\r\n * Next.js Middleware\r\n * Purpose: Apply rate limiting and security headers at the edge\r\n * \r\n * This file already exists, but we're adding rate limiting here\r\n */\r\n\r\nimport { NextResponse } from 'next/server';\r\nimport type { NextRequest } from 'next/server';\r\n\r\n// Simple in-memory rate limiter (for production, use Redis)\r\nconst rateLimitMap = new Map<string, { count: number; resetTime: number }>();\r\n\r\nfunction checkRateLimit(ip: string, limit: number, windowMs: number): boolean {\r\n  const now = Date.now();\r\n  const record = rateLimitMap.get(ip);\r\n  \r\n  if (!record || now > record.resetTime) {\r\n    rateLimitMap.set(ip, { count: 1, resetTime: now + windowMs });\r\n    return true;\r\n  }\r\n  \r\n  if (record.count >= limit) {\r\n    return false;\r\n  }\r\n  \r\n  record.count++;\r\n  return true;\r\n}\r\n\r\n// Clean up old entries periodically\r\nsetInterval(() => {\r\n  const now = Date.now();\r\n  for (const [ip, record] of rateLimitMap.entries()) {\r\n    if (now > record.resetTime) {\r\n      rateLimitMap.delete(ip);\r\n    }\r\n  }\r\n}, 60000); // Clean up every minute\r\n\r\nexport function middleware(request: NextRequest) {\r\n  // Get IP from headers (NextRequest doesn't have .ip property)\r\n  const forwardedFor = request.headers.get('x-forwarded-for');\r\n  const ip = forwardedFor ? forwardedFor.split(',')[0].trim() : request.headers.get('x-real-ip') || 'unknown';\r\n  const pathname = request.nextUrl.pathname;\r\n  \r\n  // Apply rate limiting to API routes\r\n  if (pathname.startsWith('/api/')) {\r\n    // Stricter limits for contact form\r\n    if (pathname.startsWith('/api/contact')) {\r\n      if (!checkRateLimit(ip, 3, 60 * 60 * 1000)) { // 3 per hour\r\n        return NextResponse.json(\r\n          { success: false, error: 'Too many requests. Please try again later.' },\r\n          { status: 429 }\r\n        );\r\n      }\r\n    } else {\r\n      // General API rate limit\r\n      if (!checkRateLimit(ip, 100, 15 * 60 * 1000)) { // 100 per 15 minutes\r\n        return NextResponse.json(\r\n          { success: false, error: 'Too many requests. Please try again later.' },\r\n          { status: 429 }\r\n        );\r\n      }\r\n    }\r\n  }\r\n  \r\n  // Security headers (already configured in next.config.ts, but adding here for edge)\r\n  const response = NextResponse.next();\r\n  \r\n  // Add security headers\r\n  response.headers.set('X-Content-Type-Options', 'nosniff');\r\n  response.headers.set('X-Frame-Options', 'SAMEORIGIN');\r\n  response.headers.set('X-XSS-Protection', '1; mode=block');\r\n  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');\r\n  \r\n  // HTTPS redirect (if not already in production)\r\n  if (process.env.NODE_ENV === 'production' && request.headers.get('x-forwarded-proto') !== 'https') {\r\n    const url = request.nextUrl.clone();\r\n    url.protocol = 'https';\r\n    return NextResponse.redirect(url);\r\n  }\r\n  \r\n  return response;\r\n}\r\n\r\nexport const config = {\r\n  matcher: [\r\n    '/api/:path*',\r\n    '/((?!_next/static|_next/image|favicon.ico).*)',\r\n  ],\r\n};\r\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;AAED;AAAA;;AAGA,4DAA4D;AAC5D,MAAM,eAAe,IAAI;AAEzB,SAAS,eAAe,EAAU,EAAE,KAAa,EAAE,QAAgB;IACjE,MAAM,MAAM,KAAK,GAAG;IACpB,MAAM,SAAS,aAAa,GAAG,CAAC;IAEhC,IAAI,CAAC,UAAU,MAAM,OAAO,SAAS,EAAE;QACrC,aAAa,GAAG,CAAC,IAAI;YAAE,OAAO;YAAG,WAAW,MAAM;QAAS;QAC3D,OAAO;IACT;IAEA,IAAI,OAAO,KAAK,IAAI,OAAO;QACzB,OAAO;IACT;IAEA,OAAO,KAAK;IACZ,OAAO;AACT;AAEA,oCAAoC;AACpC,YAAY;IACV,MAAM,MAAM,KAAK,GAAG;IACpB,KAAK,MAAM,CAAC,IAAI,OAAO,IAAI,aAAa,OAAO,GAAI;QACjD,IAAI,MAAM,OAAO,SAAS,EAAE;YAC1B,aAAa,MAAM,CAAC;QACtB;IACF;AACF,GAAG,QAAQ,wBAAwB;AAE5B,SAAS,WAAW,OAAoB;IAC7C,8DAA8D;IAC9D,MAAM,eAAe,QAAQ,OAAO,CAAC,GAAG,CAAC;IACzC,MAAM,KAAK,eAAe,aAAa,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,KAAK,QAAQ,OAAO,CAAC,GAAG,CAAC,gBAAgB;IAClG,MAAM,WAAW,QAAQ,OAAO,CAAC,QAAQ;IAEzC,oCAAoC;IACpC,IAAI,SAAS,UAAU,CAAC,UAAU;QAChC,mCAAmC;QACnC,IAAI,SAAS,UAAU,CAAC,iBAAiB;YACvC,IAAI,CAAC,eAAe,IAAI,GAAG,KAAK,KAAK,OAAO;gBAC1C,OAAO,sNAAY,CAAC,IAAI,CACtB;oBAAE,SAAS;oBAAO,OAAO;gBAA6C,GACtE;oBAAE,QAAQ;gBAAI;YAElB;QACF,OAAO;YACL,yBAAyB;YACzB,IAAI,CAAC,eAAe,IAAI,KAAK,KAAK,KAAK,OAAO;gBAC5C,OAAO,sNAAY,CAAC,IAAI,CACtB;oBAAE,SAAS;oBAAO,OAAO;gBAA6C,GACtE;oBAAE,QAAQ;gBAAI;YAElB;QACF;IACF;IAEA,oFAAoF;IACpF,MAAM,WAAW,sNAAY,CAAC,IAAI;IAElC,uBAAuB;IACvB,SAAS,OAAO,CAAC,GAAG,CAAC,0BAA0B;IAC/C,SAAS,OAAO,CAAC,GAAG,CAAC,mBAAmB;IACxC,SAAS,OAAO,CAAC,GAAG,CAAC,oBAAoB;IACzC,SAAS,OAAO,CAAC,GAAG,CAAC,mBAAmB;IAExC,gDAAgD;IAChD,IAAI,oDAAyB,gBAAgB,QAAQ,OAAO,CAAC,GAAG,CAAC,yBAAyB;;IAM1F,OAAO;AACT;AAEO,MAAM,SAAS;IACpB,SAAS;QACP;QACA;KACD;AACH"}}]
}